## **1. –í–≤–µ–¥–µ–Ω–∏–µ: –∑–∞—á–µ–º –Ω—É–∂–Ω—ã –±–∞—Ä—å–µ—Ä—ã –ø–∞–º—è—Ç–∏?**

–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏. –†–∞–∑–Ω–∏—Ü–∞ –≤ —Å–∫–æ—Ä–æ—Å—Ç–∏ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∏–≥–∞—Ç—å **–¥–≤—É—Ö –∏ –±–æ–ª–µ–µ –ø–æ—Ä—è–¥–∫–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä 2006 –≥–æ–¥–∞ –≤—ã–ø–æ–ª–Ω—è–ª 10 –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∑–∞ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—É, –∞ –¥–æ—Å—Ç—É–ø –∫ –ø–∞–º—è—Ç–∏ –∑–∞–Ω–∏–º–∞–ª –¥–µ—Å—è—Ç–∫–∏ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥). –ß—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –¥–∏—Å–ø—Ä–æ–ø–æ—Ä—Ü–∏—é, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **–∫—ç—à–∏, –±—É—Ñ–µ—Ä—ã –∑–∞–ø–∏—Å–∏ (store buffer), –æ—á–µ—Ä–µ–¥–∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ (invalidate queue)** –∏ –¥—Ä—É–≥–∏–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

–û–¥–Ω–∞–∫–æ —ç—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞—Ä—É—à–∞—é—Ç **–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–∞–º—è—Ç—å—é**, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –∏ –º–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ **–Ω–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é** –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∫–æ–≥–¥–∞ –ø–æ—Ç–æ–∫–∏ –≤–∏–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –∫–æ–¥–µ –æ–Ω–∏ –∏–∑–º–µ–Ω—è–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

**–ë–∞—Ä—å–µ—Ä—ã –ø–∞–º—è—Ç–∏ (memory barriers)** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É **–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–∞–º—è—Ç—å—é**, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è –∫–∞–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, —Ç–∞–∫ –∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞.

---

## **2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–Ω–æ–≤—ã: –∫—ç—à, –ø—Ä–æ—Ç–æ–∫–æ–ª MESI, store buffer, invalidate queue**

### **2.1. –ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∫—ç—à–∞ ‚Äî MESI**
–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫—ç—à–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö —è–¥–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Ç–æ–∫–æ–ª **MESI** (Modified, Exclusive, Shared, Invalid):

- **Modified (M)** ‚Äî –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω—ã –≤ —ç—Ç–æ–º –∫—ç—à–µ –∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –ø–∞–º—è—Ç–∏. –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —è–¥—Ä–æ –º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
- **Exclusive (E)** ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø–∞–º—è—Ç—å—é, –∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ —è–¥—Ä–æ –≤–ª–∞–¥–µ–µ—Ç –∏–º–∏. –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞.
- **Shared (S)** ‚Äî –¥–∞–Ω–Ω—ã–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø–∞–º—è—Ç—å—é –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ –∫—ç—à–∞—Ö –¥—Ä—É–≥–∏—Ö —è–¥–µ—Ä. –ó–∞–ø–∏—Å—å —Ç—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.
- **Invalid (I)** ‚Äî –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–ª–∏.

–ü—Ä–æ—Ç–æ–∫–æ–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **—Å–æ–æ–±—â–µ–Ω–∏—è** –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏:
- `Read` ‚Äî –∑–∞–ø—Ä–æ—Å –Ω–∞ —á—Ç–µ–Ω–∏–µ.
- `Read Invalidate` ‚Äî —á—Ç–µ–Ω–∏–µ —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —É –¥—Ä—É–≥–∏—Ö —è–¥–µ—Ä (–¥–ª—è –∑–∞–ø–∏—Å–∏).
- `Invalidate` ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à-–ª–∏–Ω–∏–∏ —É –¥—Ä—É–≥–∏—Ö —è–¥–µ—Ä.
- `Invalidate Acknowledge` ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏.
- `Writeback` ‚Äî –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞ –≤ –ø–∞–º—è—Ç—å.

---

### **2.2. Store Buffer (–±—É—Ñ–µ—Ä –∑–∞–ø–∏—Å–∏)**
–ß—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –∫—ç—à-–ª–∏–Ω–∏—è —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –∑–∞–ø–∏—Å–∏, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ–º–µ—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ **store buffer** –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ. –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É, –Ω–æ **–Ω–∞—Ä—É—à–∞–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π**:

- –ó–∞–ø–∏—Å—å –≤ `store buffer` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–¥–æ** —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞.
- –î—Ä—É–≥–∏–µ —è–¥—Ä–∞ **–Ω–µ –≤–∏–¥—è—Ç** —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø–æ–∫–∞ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ –∫—ç—à.

**–ü—Ä–æ–±–ª–µ–º–∞**: –µ—Å–ª–∏ –ø–æ—Ç–æ–∫ 1 –ø–∏—à–µ—Ç `a=1`, –∑–∞—Ç–µ–º `flag=true`, –∞ –ø–æ—Ç–æ–∫ 2 —á–∏—Ç–∞–µ—Ç `flag`, –∞ –ø–æ—Ç–æ–º `a`, –æ–Ω –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å `flag==true`, –Ω–æ `a==0`, –ø–æ—Ç–æ–º—É —á—Ç–æ `a` –µ—â—ë –≤ –±—É—Ñ–µ—Ä–µ.

---

### **2.3. Invalidate Queue (–æ—á–µ—Ä–µ–¥—å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π)**
–ú—ã —É–∂–µ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏, —á—Ç–æ —Å –≤–≤–µ–¥–µ–Ω–∏–µ–º –±—É—Ñ–µ—Ä–∞ –∑–∞–ø–∏—Å–∏, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è –æ—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∏ –º–æ–∂–µ—Ç —Ä–∞—Å—Å—ã–ª–∞—Ç—å —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—â—É—Ç–∏–º–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ –∂–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ.

1. CPU2 –∏—Å–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å–≤–æ–µ–≥–æ –ø–æ—Ç–æ–∫–∞.
2. CPU2 –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç CPU1.
3. CPU2 —Å–ª–æ–º—è –≥–æ–ª–æ–≤—É –Ω–µ—Å—ë—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â—É—é—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç CPU1.

–ù–∞–¥–æ –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ —Ç—Ä–∞—Ñ—Ñ–∏–∫ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞–º–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–µ—Å—å–º–∞ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ —É CPU2 –Ω–∏–∫–∞–∫–∏—Ö –Ω–µ—Ä–≤–æ–≤ –Ω–µ —Ö–≤–∞—Ç–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Å–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ –¥–µ–ª–∞ –∏ –∏—Å–ø–æ–ª–Ω—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç CPU1. –ß—Ç–æ–±—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å CPU –Ω–∞ —Ç–æ, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö CPU, –≤–≤–æ–¥—è—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å ‚Äì –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π. 

–í—Å—è —Å—É—Ç—å –µ—ë –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∞ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö CPU, –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞—è –∏–º —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ –±—ã —Å–∞–º CPU –∏—Å–ø–æ–ª–Ω–∏–ª –∏—Ö –ø—Ä–æ—Å—å–±—É(–µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –≤–æ–æ–±—â–µ –Ω—É–∂–µ–Ω). –ü—Ä–∏ —ç—Ç–æ–º, —Å–∞–º CPU –≤–æ–æ–±—â–µ –Ω–µ –¥–æ–≥–∞–¥—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –µ–º—É –ø—Ä–∏—à–ª–æ –∫–∞–∫–æ–µ-—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –æ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö ‚Äú–¥—ë—Ä–≥–∞–Ω–∏–π‚Äù, —á—Ç–æ –¥–∞—ë—Ç –µ–º—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—Å—è –Ω–∞ —Å–≤–æ–µ–π –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ ‚Äì –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ—Ç–æ–∫–∞.

---

### **2.4. Store Forwarding**
–ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —á—Ç–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫—ç—à–∞, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –µ—â—ë –≤ `store buffer`, —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è **store forwarding**: –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `store buffer`, –∏ –µ—Å–ª–∏ —Ç–∞–º –µ—Å—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë.

–≠—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç **—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —è–¥—Ä–∞**, –Ω–æ –Ω–µ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –º–µ–∂–¥—É —è–¥—Ä–∞–º–∏.

---

## **3. –¢–∏–ø—ã –±–∞—Ä—å–µ—Ä–æ–≤ –ø–∞–º—è—Ç–∏**

–ë–∞—Ä—å–µ—Ä—ã –ø–∞–º—è—Ç–∏ ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ **–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è** –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏.

### **3.1. –ß–µ—Ç—ã—Ä–µ –±–∞–∑–æ–≤—ã—Ö —Ç–∏–ø–∞ –±–∞—Ä—å–µ—Ä–æ–≤**
| –ë–∞—Ä—å–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|
| **LoadLoad** | –í—Å–µ `load` –¥–æ –±–∞—Ä—å–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ `load` –ø–æ—Å–ª–µ –±–∞—Ä—å–µ—Ä–∞. |
| **LoadStore** | –í—Å–µ `load` –¥–æ –±–∞—Ä—å–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ `store` –ø–æ—Å–ª–µ –±–∞—Ä—å–µ—Ä–∞. |
| **StoreStore** | –í—Å–µ `store` –¥–æ –±–∞—Ä—å–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ `store` –ø–æ—Å–ª–µ –±–∞—Ä—å–µ—Ä–∞. |
| **StoreLoad** | –í—Å–µ `store` –¥–æ –±–∞—Ä—å–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –¥–æ –Ω–∞—á–∞–ª–∞ `load` –ø–æ—Å–ª–µ –±–∞—Ä—å–µ—Ä–∞. |

> **StoreLoad** ‚Äî —Å–∞–º—ã–π —Ç—è–∂—ë–ª—ã–π –±–∞—Ä—å–µ—Ä, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç **–ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ store buffer** –∏ –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–π.

---

### **3.2. –ü–æ–ª–Ω—ã–µ –∏ —á–∞—Å—Ç–∏—á–Ω—ã–µ –±–∞—Ä—å–µ—Ä—ã**
- **–ü–æ–ª–Ω—ã–π –±–∞—Ä—å–µ—Ä (Full Memory Barrier)** ‚Äî –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —á–µ—Ç—ã—Ä—ë—Ö: `LoadLoad + LoadStore + StoreLoad + StoreStore`.
  - –ó–∞–ø—Ä–µ—â–∞–µ—Ç **–ª—é–±—ã–µ** –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏.
  - –ù–∞ x86 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `mfence`, –Ω–∞ ARM ‚Äî `dmb`.
- **–ë–∞—Ä—å–µ—Ä —á—Ç–µ–Ω–∏—è (Read Barrier)** ‚Äî `LoadLoad + LoadStore`.
- **–ë–∞—Ä—å–µ—Ä –∑–∞–ø–∏—Å–∏ (Write Barrier)** ‚Äî `StoreStore + StoreLoad` (–∏–Ω–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ `StoreStore`).

---

### **3.3. –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –±–∞—Ä—å–µ—Ä–æ–≤ –Ω–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –≠—Ñ—Ñ–µ–∫—Ç –±–∞—Ä—å–µ—Ä–∞ |
|----------|----------------|
| **–ö–æ–º–ø–∏–ª—è—Ç–æ—Ä** | –ù–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–ª—è—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ –±–∞—Ä—å–µ—Ä. |
| **Store Buffer** | –û—á–∏—â–∞–µ—Ç—Å—è (–≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ –∫—ç—à—É). |
| **Invalidate Queue** | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–≤—Å–µ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è). |

---

## **4. –ú–æ–¥–µ–ª–∏ –ø–∞–º—è—Ç–∏ –≤ C++ (C++11 –∏ –¥–∞–ª–µ–µ)**

C++11 –≤–≤—ë–ª **–∞—Ç–æ–º–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –∏ **–º–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏**, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ **acquire/release —Å–µ–º–∞–Ω—Ç–∏–∫–µ**, –∞ –Ω–µ –Ω–∞ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã—Ö –±–∞—Ä—å–µ—Ä–∞—Ö.

### **4.1. –ú–æ–¥–µ–ª–∏ —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è (memory_order)**
| –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ | –ì–∞—Ä–∞–Ω—Ç–∏–∏ | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ |
|----------------|---------|---------------|
| **`memory_order_relaxed`** | –ù–µ—Ç –±–∞—Ä—å–µ—Ä–æ–≤. –¢–æ–ª—å–∫–æ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å. | –°—á—ë—Ç—á–∏–∫–∏, –≥–¥–µ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ –≤–∞–∂–µ–Ω. |
| **`memory_order_acquire`** | –ë–∞—Ä—å–µ—Ä—ã: `LoadLoad`, `LoadStore`. | –ß—Ç–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `flag.load(acquire)`). |
| **`memory_memoy_order_release`** | –ë–∞—Ä—å–µ—Ä—ã: `StoreStore`, `StoreLoad`. | –ó–∞–ø–∏—Å—å —Ñ–ª–∞–≥–∞ –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `flag.store(true, release)`). |
| **`memory_order_acq_rel`** | `acquire` + `release`. | –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è-–∑–∞–ø–∏—Å–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `fetch_add`). |
| **`memory_order_seq_cst`** | –ü–æ–ª–Ω—ã–π –±–∞—Ä—å–µ—Ä (`LoadLoad`, `LoadStore`, `StoreLoad`, `StoreStore`). | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å. |
| **`memory_order_consume`** | –°–ª–∞–±–µ–µ `acquire`. –î–ª—è –∑–∞–≤–∏—Å–∏–º—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π. | –†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Å–ª–æ–∂–µ–Ω –≤ –ø–æ–Ω–∏–º–∞–Ω–∏–∏. |

---

### **4.2. –ü—Ä–∏–º–µ—Ä: acquire/release —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
```cpp
std::atomic<bool> flag{false};
int data = 0;

// –ü–æ—Ç–æ–∫ 1
void producer() {
    data = 42;                          // 1
    flag.store(true, std::memory_order_release); // 2
}

// –ü–æ—Ç–æ–∫ 2
void consumer() {
    while (!flag.load(std::memory_order_acquire)); // 3
    assert(data == 42); // 4 ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ true
}
```

- `release` (2) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ `data = 42` –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ **–¥–æ –∏–ª–∏ –≤–º–µ—Å—Ç–µ** —Å `flag = true`.
- `acquire` (3) –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —á—Ç–µ–Ω–∏—è (4) —É–≤–∏–¥—è—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ **–¥–æ** `release`.

 –≠—Ç–æ **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç** –ø–æ—Ç–æ–∫–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞.

---

## **5. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è**

### **5.1. x86 vs ARM**
- **x86**: –∏–º–µ–µ—Ç **–æ—á–µ–Ω—å —Å—Ç—Ä–æ–≥—É—é –º–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏**.
  - –õ—é–±–æ–µ —á—Ç–µ–Ω–∏–µ ‚Äî –∫–∞–∫ `acquire`.
  - –õ—é–±–∞—è –∑–∞–ø–∏—Å—å ‚Äî –∫–∞–∫ `release`.
  - `StoreLoad` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –±–∞—Ä—å–µ—Ä (`mfence`).
- **ARM/PowerPC**: **—Å–ª–∞–±–∞—è –º–æ–¥–µ–ª—å –ø–∞–º—è—Ç–∏**.
  - –í—Å–µ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã.
  - –¢—Ä–µ–±—É—é—Ç—Å—è **—è–≤–Ω—ã–µ –±–∞—Ä—å–µ—Ä—ã** –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

üëâ –ö–æ–¥, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∞ x86, **–º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è** –Ω–∞ ARM –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö `memory_order`.

---

### **5.2. –°—É–ø–µ—Ä—Å–ª–∞–±–∞—è –º–æ–¥–µ–ª—å: DEC Alpha**
- –†–∞–∑—Ä–µ—à–∞–µ—Ç **–ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**.
- –ü—Ä–∏–º–µ—Ä:
  ```cpp
  p = new int(42);
  q = p; // –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –î–û new!
  ```
  –î—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç —É–≤–∏–¥–µ—Ç—å `q != nullptr`, –Ω–æ –ø—Ä–∏ —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–∏ ‚Äî **–ø–∞–¥–µ–Ω–∏–µ**.

üëâ –¢—Ä–µ–±—É–µ—Ç **—Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∞—Ä—å–µ—Ä–æ–≤** –¥–∞–∂–µ –≤ –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞—è—Ö.

---

## **6. –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –±–∞—Ä—å–µ—Ä—ã?**

1. **–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∞—Ç–æ–º–∏–∫–∞–º–∏** ‚Äî –≤—ã–±–æ—Ä `memory_order` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –±–∞—Ä—å–µ—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è.
2. **–ü—Ä–∏ –∑–∞—Ö–≤–∞—Ç–µ/–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –º—å—é—Ç–µ–∫—Å–æ–≤** ‚Äî –≤–Ω—É—Ç—Ä–∏ `lock()` –∏ `unlock()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –±–∞—Ä—å–µ—Ä—ã.
3. **–í –¥—Ä–∞–π–≤–µ—Ä–∞—Ö –∏ –û–°-–∫–æ–¥–µ** ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ —è–¥—Ä–µ Linux `smp_mb()`, `smp_rmb()`, `smp_wmb()` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É CPU –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏.
4. **–ü—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä** ‚Äî –±–µ–∑ –±–∞—Ä—å–µ—Ä–æ–≤ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å.

---

## **7. –†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π**

### **7.1. –ü—Ä–∏–º–µ—Ä –∏–∑ —è–¥—Ä–∞ Linux (—Ñ—å—é—Ç–µ–∫—Å—ã, 2014)**
- –ù–∞ –º–Ω–æ–≥–æ–∫—è–¥–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –ø–æ—Ç–æ–∫–∏ **–Ω–µ –≤–∏–¥–µ–ª–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**.
- –ü—Ä–∏—á–∏–Ω–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `smp_mb()` –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–ª–∞–≥–∞.
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ **–±–∞—Ä—å–µ—Ä–∞ –∑–∞–ø–∏—Å–∏** –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–ª–∞–≥–∞.

---

### **7.2. –ü—Ä–∏–º–µ—Ä —Å sharedFlag –∏ sharedData**
```cpp
bool sharedFlag = false;
long long sharedData = 0;

// Thread 1
void thread1() {
    sharedData = 555;
    compiler_barrier(); // –¢–æ–ª—å–∫–æ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä!
    sharedFlag = true;  // –ú–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –≤ store buffer
}

// Thread 2
void thread2() {
    while (!sharedFlag);
    assert(sharedData == 555); // –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å!
}
```

üëâ –†–µ—à–µ–Ω–∏–µ:
```cpp
sharedFlag.store(true, std::memory_order_release);
while (!flag.load(std::memory_order_acquire));
```

---

## **8. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**

- **`seq_cst`** ‚Äî —Å–∞–º—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π, –Ω–æ **—Å–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π** (–ø–æ–ª–Ω—ã–π –±–∞—Ä—å–µ—Ä).
- **`acquire/release`** ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ ARM.
- **`relaxed`** ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏.

üëâ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–º–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ** –±–∞—Ä—å–µ—Ä—ã:
- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ‚Äî `acquire/release`.
- –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ—Ä—è–¥–æ–∫ ‚Äî `seq_cst`.

---

## **9. –í—ã–≤–æ–¥—ã**

1. **–ë–∞—Ä—å–µ—Ä—ã –ø–∞–º—è—Ç–∏ ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã** –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö.
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (store buffer, invalidate queue)** –Ω–∞—Ä—É—à–∞—é—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π.
3. **C++11 memory model** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã (`acquire/release`), –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É—é—â–∏–µ—Å—è –æ—Ç –¥–µ—Ç–∞–ª–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
4. **x86 –º–∞—Å–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã**, –Ω–æ –Ω–∞ ARM/PowerPC/Alpha –∫–æ–¥ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è –±–µ–∑ —è–≤–Ω—ã—Ö –±–∞—Ä—å–µ—Ä–æ–≤.
5. **–í—ã–±–æ—Ä memory_order ‚Äî –∫–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é**.

---

## **10. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **`memory_order_seq_cst`**.
- –í –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–∞—Ö ‚Äî `acquire/release`.
- –ò–∑–±–µ–≥–∞–π—Ç–µ `relaxed`, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã.
- –í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ **—Å–ª–∞–±—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö** (ARM).
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–º—å—é—Ç–µ–∫—Å—ã**, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã –≤ –∞—Ç–æ–º–∏–∫–∞—Ö.

---

> **"–ë–∞—Ä—å–µ—Ä—ã –ø–∞–º—è—Ç–∏ ‚Äî —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –∑–ª–æ, —Ç—Ä–µ–±—É—é—â–µ–µ—Å—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏."**



















### –í–æ–∑–º–æ–∂–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞—Ä—å–µ—Ä–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞/–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
(–ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã)
```c
#define rte_compiler_barrier() do { asm volatile ("" : : : "memory"); } while(0)

// rte_smp_wmb = Write Memory Barrier - —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ—Ç –∑–∞–ø–∏—Å—å(sfence –Ω–∞ x86)
// rte_smp_rmb = Read Memory Barrier - —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ—Ç —á—Ç–µ–Ω–∏–µ(lfence –Ω–∞ x86)
// rte_smp_mb = Read+Write Memory Barrier - —É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ—Ç —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å(mfence  –Ω–∞ x86)

/* On PowerPC (PPC) platform */
#define	rte_mb()  asm volatile("sync" : : : "memory")
#define	rte_wmb() asm volatile("sync" : : : "memory")
#define	rte_rmb() asm volatile("sync" : : : "memory")
#define rte_smp_mb() rte_mb()
#define rte_smp_wmb() rte_wmb()
#define rte_smp_rmb() rte_rmb()
#define rte_io_mb() rte_mb()
#define rte_io_wmb() rte_wmb()
#define rte_io_rmb() rte_rmb()

/* On x86 platform */
#define	rte_mb() _mm_mfence()
#define	rte_wmb() _mm_sfence()
#define	rte_rmb() _mm_lfence()
#define rte_smp_wmb() rte_compiler_barrier()
#define rte_smp_rmb() rte_compiler_barrier()

```

### **–ü—Ä–∏–º–µ—Ä: Producer-Consumer —Å Shared Data**
```c
#include <rte_atomic.h>
#include <rte_pause.h>

struct Data {
    int64_t a, b;
    volatile bool updated; // volatile –¥–ª—è –∑–∞–ø—Ä–µ—Ç–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
};

// –ü–æ—Ç–æ–∫ 1 (–ü–∏—Å–∞—Ç–µ–ª—å)
void producer(struct Data* d) {
    d->a = 10;            // (1)
    d->b = 20;            // (2)
    rte_compiler_barrier(); // –ë–∞—Ä—å–µ—Ä –∑–¥–µ—Å—å!
    d->updated = true;     // (3)
}

// –ü–æ—Ç–æ–∫ 2 (–ß–∏—Ç–∞—Ç–µ–ª—å)
void consumer(struct Data* d) {
    while (!d->updated) {  // (4)
        rte_pause(); // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ
    }
    rte_compiler_barrier();
    printf("a=%ld, b=%ld", d->a, d->b); // (5)
}
```

### **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `rte_compiler_barrier()`?**
1. **–ó–∞–ø—Ä–µ—â–∞–µ—Ç –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π**:
   - –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä **–Ω–µ –º–æ–∂–µ—Ç** –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `d->updated = true` **–¥–æ** –∑–∞–ø–∏—Å–∏ –≤ `a` –∏ `b`
   - –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: (1) ‚Üí (2) ‚Üí (3) (–§–æ—Ä–º–∞–ª—å–Ω–æ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –º–µ–∂–¥—É —Å–æ–±–æ–π d->a = 10 & d->b = 20, –Ω–æ –Ω–µ –∏–Ω–∞—á–µ —á—Ç–æ –±—ã –∑–∞–ø–∏—Å—Ç—å d->updated = true –æ–∫–∞–∑–∞–ª–æ—Å—å –≤—ã—à–µ —á–µ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∏–∑ d->a = 10 & d->b = 20)

2. **–ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**:
   - CPU –≤—Å—ë –µ—â—ë –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ out-of-order
   - –î–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –±–∞—Ä—å–µ—Ä–∞ –Ω—É–∂–Ω—ã `rte_smp_wmb()`/`rte_rmb()`

3. **–ó–∞—á–µ–º `volatile`?**:
   - –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ `updated` –≤ —Ä–µ–≥–∏—Å—Ç—Ä–µ
   - –ë–µ–∑ `volatile` –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—ã–Ω–µ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É `!d->updated` –∏–∑ —Ü–∏–∫–ª–∞

---

### **–ö–∞–∫ –º–æ–≥ –±—ã –æ—à–∏–±–∏—Ç—å—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –±–µ–∑ –±–∞—Ä—å–µ—Ä–∞?**
#### –í–æ–∑–º–æ–∂–Ω–æ–µ –æ—à–∏–±–æ—á–Ω–æ–µ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ:
```asm
; –ë–µ–∑ –±–∞—Ä—å–µ—Ä–∞ (–ø—Å–µ–≤–¥–æ–∫–æ–¥)
producer:
    mov     [d->updated], 1    ; (3) —Å–Ω–∞—á–∞–ª–∞ —Ñ–ª–∞–≥!
    mov     [d->a], 10         ; (1)
    mov     [d->b], 20         ; (2)
```
**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ**: Consumer —É–≤–∏–¥–∏—Ç `updated=true`, –Ω–æ `a` –∏ `b` –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.

#### –° –±–∞—Ä—å–µ—Ä–æ–º:
```asm
producer:
    mov     [d->a], 10         ; (1)
    mov     [d->b], 20         ; (2)
    ; –ë–∞—Ä—å–µ—Ä –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ (–ø—É—Å—Ç–∞—è asm-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
    mov     [d->updated], 1    ; (3) —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ a –∏ b
```

---

### **–ü–æ—á–µ–º—É —ç—Ç–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤?**
1. **–ü—Ä–æ–±–ª–µ–º–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏**:
   - –î—Ä—É–≥–æ–µ —è–¥—Ä–æ CPU –º–æ–∂–µ—Ç **–Ω–µ —É–≤–∏–¥–µ—Ç—å** –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É (–∫—ç—à-–ª–∏–Ω–∏–∏)
   - –ù—É–∂–µ–Ω **–∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π –±–∞—Ä—å–µ—Ä** (`rte_smp_wmb()`)

2. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å**:
   - –î–ª—è `int64_t` –Ω–∞ 32-–±–∏—Ç–Ω—ã—Ö CPU –≤–æ–∑–º–æ–∂–µ–Ω **—á–∞—Å—Ç–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø**
   - –†–µ—à–µ–Ω–∏–µ: `rte_atomic64_t` –∏–ª–∏ `std::atomic`

---

### **–ü–æ–ª–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä—Å–∏—è (DPDK-style)**
```c
#include <rte_atomic.h>
#include <rte_pause.h>

struct SafeData {
    int64_t a, b;           // –ù–µ–∞—Ç–æ–º–∞—Ä–Ω—ã–µ
    rte_atomic16_t updated;  // –¢–æ–ª—å–∫–æ —Ñ–ª–∞–≥ –∞—Ç–æ–º–∞—Ä–Ω—ã–π
};

// –ü–æ—Ç–æ–∫ 1: –ü–∏—Å–∞—Ç–µ–ª—å
void safe_producer(struct SafeData* d) {
    d->a = 10;     // –û–±—ã—á–Ω–∞—è –∑–∞–ø–∏—Å—å
    d->b = 20;     // –û–±—ã—á–Ω–∞—è –∑–∞–ø–∏—Å—å
    rte_smp_wmb(); // –ë–∞—Ä—å–µ—Ä –∑–∞–ø–∏—Å–∏ (–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å–≤—É—é—â–π –∫–æ–¥—É)
    rte_atomic16_set(&d->updated, 1); // –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Ñ–ª–∞–≥
}

// –ü–æ—Ç–æ–∫ 2: –ß–∏—Ç–∞—Ç–µ–ª—å
void safe_consumer(struct SafeData* d) {
    while (!rte_atomic16_read(&d->updated)) {
        rte_pause();        // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ
    }
    rte_smp_rmb();          // –ë–∞—Ä—å–µ—Ä —á—Ç–µ–Ω–∏—è
    printf("a=%ld, b=%ld", d->a, d->b); // –û–±—ã—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
}
```

