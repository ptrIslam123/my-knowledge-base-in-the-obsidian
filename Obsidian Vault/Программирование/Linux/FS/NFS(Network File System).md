NFS (Network File System) — это протокол распределённой файловой системы, позволяющий монтировать удалённые каталоги как локальные. Разработан Sun Microsystems в 1984 году. Современные версии (NFSv4/NFSv4.1) обеспечивают безопасность, кэширование и высокую производительность.

## **Основные компоненты NFS**

| Компонент          | Описание                                                                 |
|--------------------|--------------------------------------------------------------------------|
| **NFS-сервер**     | Машина, которая предоставляет (экспортирует) каталоги для общего доступа |
| **NFS-клиент**     | Машина, которая монтирует удалённые каталоги                            |
| **rpcbind**        | Служба, сопоставляющая RPC-сервисы с портами (обязательна для NFSv3)     |
| **mountd**         | Управляет правами доступа к файлам                                       |
| **nfsd**           | Демон, обрабатывающий запросы NFS-клиентов                              |

---

## **Установка NFS**

```bash
sudo apt update && sudo apt install nfs-kernel-server nfs-common
```

---

## **Настройка сервера NFS**

### **1. Создайте каталог для экспорта**
```bash
sudo mkdir /srv/nfs_share
sudo chown nobody:nogroup /srv/nfs_share  # Специальные права для NFS
sudo chmod 777 /srv/nfs_share             # Временное решение для теста
```

### **2. Настройте экспорт в `/etc/exports`**
Все экспортируемые файловые системы должны быть описаны в **/etc/exports**:
```bash
sudo nano /etc/exports
```

Синатаксис записей имеет следующую структуру:
```text
share-directory host-address(mode)
```

* share-directory - полный путь к разделяемому каталогу
* host-address - адрес, которому разрешается доступ, можно указать * - всем, сеть или отдельный адрес или имя хоста
* mode - см таблицу ниже

| Параметр             | Описание                                                                                                                                                     |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **rw**               | Разрешает запись в экспортируемую директорию.                                                                                                                |
| **sync**             | Сообщает клиенту об успешной записи только после фактической записи на диск. Немного замедляет работу, но повышает надёжность и предотвращает потерю данных. |
| **crossmnt**         | Автоматически экспортирует вложенные файловые системы вместе с корневой.                                                                                     |
| **fsid=0**           | Указывает, что данная файловая система является корневой (используется при экспорте нескольких файловых систем).                                             |
| **no_subtree_check** | Отключает проверку, находится ли запрашиваемый файл в экспортированном подкаталоге. Повышает производительность, но немного снижает безопасность.            |
| **wdelay**           | Позволяет серверу откладывать запись, если ожидается ещё одна операция записи, чтобы объединить их. Увеличивает производительность при высокой нагрузке.     |
| **all_squash**       | понижать права всех пользователей до **nobody:nogroup**                                                                                                      |

**`На последней опции остановимся более подробно, NFS по умолчанию не использует аутентификацию и доступ разграничивается по IP-адресам и стандартным UNIX-правам. При этом важно понимать, что права определяются не по имени пользователя, а по его UID/GID, т.е. идентификаторам. В целях безопасности NFS умеет понижать права до минимальных, но по умолчанию это применяется только к суперпользователю, а обычные пользователи будут подключаться со своими UID/GID, но так как мы назначили владельцем экспортируемых директорий **nobody:nogroup**, то нам нужно также понизить в правах и обычных пользователей, либо пересмотреть всю систему прав доступа.`**

**`Отдельно бы хотелось предостеречь от использования опции **no_root_squash**, которая отключает понижение прав root при подключении к NFS, это очень большая дыра в безопасности, так как позволяет пользователю с **локальными** правами администратора залить на сервер исполняемый файл с установленным битом SUID, что будет означать смену прав на суперпользователя при его запуске из-под обычной учетной записи.`**

### Пример
```bash
/srv/nfs_share 192.168.1.0/24(rw,sync,no_subtree_check,no_root_squash)
```
Где:
- `192.168.1.0/24` — разрешённые подсети (можно указать конкретный IP)
- `rw` — чтение и запись
- `sync` — синхронная запись (гарантия сохранности данных)
- `no_subtree_check` — ускоряет доступ к подкаталогам
- `no_root_squash` — позволяет root-доступ (опасно для продакшена!)

### **3. Примените изменения**
```bash
sudo exportfs -ra          # Перечитываем /etc/exports
sudo systemctl restart nfs-kernel-server
```

### **4. Проверьте список экспортируемых каталогов**
```bash
sudo exportfs -v
```
Пример вывода:
```
/srv/nfs_share  192.168.1.0/24(rw,wdelay,no_root_squash,no_subtree_check)
```

---

## **Настройка клиента NFS**

### **1. Создайте точку монтирования**
```bash
sudo mkdir /mnt/nfs_client
```

### **2. Монтируем вручную**
```bash
sudo mount -t nfs 192.168.1.100:/srv/nfs_share /mnt/nfs_client
```
Где `192.168.1.100` — IP NFS-сервера.

### **3. Автомонтирование при загрузке**
Добавьте в `/etc/fstab`:
```bash
192.168.1.100:/srv/nfs_share  /mnt/nfs_client  nfs  rw,soft,intr,noatime  0  0
```
Опции:
- `soft` — не зависать при проблемах с сетью
- `intr` — разрешить прерывание операций
- `noatime` — не обновлять время доступа (для производительности)

### **4. Проверьте монтирование**
```bash
df -hT | grep nfs
mount | grep nfs
```

---

### **Проверка доступности**
```bash
rpcinfo -p 192.168.1.100
showmount -e 192.168.1.100
```

---
## **Безопасность NFS**

### **1. Ограничьте доступ по IP**
В `/etc/exports` укажите конкретные IP:
```bash
/srv/nfs_share 192.168.1.50(rw,sync) 192.168.1.51(ro,sync)
```

### **2. Запретите root-доступ**
Замените `no_root_squash` на `root_squash` (по умолчанию).

### **3. Настройте firewall**
```bash
sudo ufw allow from 192.168.1.0/24 to any port nfs
sudo ufw enable
```

### **4. Используйте Kerberos (NFSv4)**
```bash
sudo apt install krb5-user
```
В `/etc/exports`:
```bash
/srv/nfs_share *(sec=krb5p,rw,sync)
```

---

## **Производительность NFS**

### **Оптимальные параметры монтирования**
```bash
sudo mount -t nfs -o rsize=65536,wsize=65536,timeo=15 192.168.1.100:/share /mnt/nfs
```
Где:
- `rsize/wsize` — размер блока чтения/записи (макс. 65536)
- `timeo` — таймаут в десятых долях секунды

### **Тест скорости**
```bash
# Запись
dd if=/dev/zero of=/mnt/nfs/testfile bs=1G count=1 oflag=direct

# Чтение
dd if=/mnt/nfs/testfile of=/dev/null bs=1G count=1 iflag=direct
```

---
## **Управление службами**

| Действие                | Команда                                    |
| ----------------------- | ------------------------------------------ |
| Перезапуск NFS-сервера  | `sudo systemctl restart nfs-kernel-server` |
| Проверка статуса        | `sudo systemctl status nfs-kernel-server`  |
| Автозагрузка при старте | `sudo systemctl enable nfs-kernel-server`  |

---

## **Альтернативы NFS**
- **Samba** — для доступа из Windows
- **SSHFS** — через SSH (медленнее, но безопаснее)
- **GlusterFS** — для распределённых хранилищ
