# Как устроен VPN под капотом?

- [1. Туннелирование (Tunneling)](https://dzen.ru/a/ZvWiVYiEvxDQwdCT#1_tynnelirovanie_tunneling)
- [1.1. PPTP (Point-to-Point Tunneling Protocol)](https://dzen.ru/a/ZvWiVYiEvxDQwdCT#11_pptp_point_to_point_tunneling_prot)
- [Структура протокола PPTP:](https://dzen.ru/a/ZvWiVYiEvxDQwdCT#stryktyra_protokola_pptp)

**VPN** (виртуальная частная сеть, Virtual Private Network) — это технология, которая позволяет создать защищённое соединение через небезопасные сети, такие как Интернет.

## Вот как это работает по простому:

**1. Шифрование данных**:
Когда ты используешь VPN, все данные, которые ты отправляешь и получаешь через интернет (например, посещение сайтов, переписка и т.д.), шифруются. Это значит, что если кто-то попытается перехватить твои данные (например, хакеры или провайдер), они не смогут их понять.

**2. Изменение IP-адреса**:
VPN меняет твой реальный IP-адрес на адрес сервера, через который ты подключаешься. Это помогает скрыть твоё местоположение и делает твою интернет-активность анонимной.

**3. Туннелирование**:
Вся информация, которую ты отправляешь в интернет, проходит через защищённый «туннель». Этот туннель создаётся между твоим устройством и VPN-сервером. Никто не может заглянуть внутрь этого туннеля, что повышает безопасность.

**4. Доступ к заблокированным ресурсам**:
Поскольку VPN может поменять твой IP-адрес на адрес сервера в другой стране, ты сможешь заходить на сайты и сервисы, которые недоступны в твоей стране. Например, если сайт заблокирован для твоего региона, через VPN его можно будет открыть, притворившись, что ты находишься в другой стране.

Под капотом VPN работают несколько ключевых компонентов и технологий, которые обеспечивают шифрование, аутентификацию и туннелирование данных. Вот основные аспекты работы VPN

## 1. **Туннелирование (Tunneling)**

VPN создает "туннель" между клиентом (вашим устройством) и сервером VPN. Этот туннель — это зашифрованное соединение, по которому данные передаются между клиентом и сервером. Основная задача туннеля — защитить передаваемые данные и скрыть их от третьих лиц.

Туннелирование работает на основе протоколов, которые инкапсулируют данные в пакеты и передают их через публичную сеть. Существует несколько популярных протоколов туннелирования:

- **PPTP (Point-to-Point Tunneling Protocol)** — один из старейших протоколов, который обеспечивает базовый уровень шифрования, но считается устаревшим и уязвимым.

- **L2TP/IPsec (Layer 2 Tunneling Protocol)** — более современная комбинация протоколов, которая обеспечивает более высокую безопасность за счёт использования IPsec для шифрования.
   
- **OpenVPN** — открытый стандарт, который использует различные методы шифрования (например, TLS) и считается одним из самых надёжных и гибких протоколов.
   
- **IKEv2/IPsec (Internet Key Exchange version 2)** — быстрый и безопасный протокол, особенно эффективный для мобильных устройств благодаря поддержке механизма восстановления соединения при смене сети (например, при переключении с Wi-Fi на мобильные данные).
   
- **WireGuard** — относительно новый и очень легковесный протокол, который предлагает высокий уровень безопасности и производительности.
   

## 1.1. PPTP (Point-to-Point Tunneling Protocol)

**Описание**: PPTP — один из старейших VPN-протоколов, впервые разработанный Microsoft в 1995 году. Его основная задача — создание туннеля между клиентом и сервером с базовым шифрованием.

**Как работает**: PPTP использует туннелирование для инкапсуляции пакетов PPP (Point-to-Point Protocol) через IP-соединение. Он использует стандартные механизмы PPP для аутентификации (например, MS-CHAPv2) и обеспечивает шифрование с помощью протокола MPPE (Microsoft Point-to-Point Encryption).

### **Структура протокола PPTP**:

PPTP состоит из нескольких компонентов, но основным для инкапсуляции данных является **PPP (Point-to-Point Protocol)**, который используется для туннелирования данных.

**1. PPP-заголовок**:

- Флаги (Flag): 1 байт
- Адрес (Address): 1 байт
- Управление (Control): 1 байт   
- Протокол (Protocol): 2 байта (определяет тип передаваемых данных, например, IP, IPX и т.д.)


**2. PPP-пакет**:

- Поле данных (Data): Переменная длина (содержит инкапсулированные данные, например, IP-пакет).
- CRC (Cyclic Redundancy Check): 2-4 байта (контрольная сумма для проверки целостности пакета).

**3. PPTP-заголовок**:

- Тип сообщения: 2 байта (например, управляющее сообщение или передача данных).
- Версия: 2 байта (версия PPTP).
- Идентификатор: 4 байта (идентификатор соединения).
- Длина сообщения: 2 байта (длина PPTP-сообщения).
- Поля управления соединением: Переменная длина (используется для управления туннелем).  


Процесс работы PPTP инкапсулирует данные внутри PPP и передает через туннель, используя GRE (Generic Routing Encapsulation) для инкапсуляции PPP-пакетов.

### **Проблемы**:

- **Безопасность**: PPTP считается устаревшим и уязвимым. Известны многочисленные уязвимости в шифровании MPPE и механизмах аутентификации, таких как MS-CHAPv2.

- **Производительность**: Из-за низкого уровня шифрования PPTP часто демонстрирует высокую скорость. Однако это происходит за счет безопасности.

### **Заключение**:
Хотя PPTP прост в настройке и предлагает высокие скорости, его использование крайне не рекомендуется из-за серьезных проблем с безопасностью.

## 1.2. L2TP/IPsec (Layer 2 Tunneling Protocol)

**Описание**: L2TP (Layer 2 Tunneling Protocol) сам по себе не обеспечивает шифрования, но часто используется в комбинации с IPsec (Internet Protocol Security) для защиты данных. Эта комбинация значительно улучшает безопасность по сравнению с PPTP.

**Как работает**:

- **L2TP**: Отвечает за создание туннеля (инкапсуляцию данных). Он инкапсулирует данные уровня 2 (например, PPP-пакеты) в IP-пакеты для их передачи через интернет.

- **IPsec**: Используется для шифрования, аутентификации и обеспечения целостности данных. IPsec использует несколько методов шифрования, таких как AES, для защиты данных. Он также обеспечивает аутентификацию с использованием протоколов, таких как IKE (Internet Key Exchange).

### **Структура протокола L2TP**:

L2TP сам по себе не обеспечивает шифрования, он используется для туннелирования. Для обеспечения безопасности чаще всего применяется IPsec.

**1. L2TP-заголовок**:

- Поле управления: 2 байта (определяет тип сообщения: данные или управление).
- Версия: 1 байт (номер версии L2TP).
- Идентификатор туннеля: 2 байта (идентификатор туннеля).
- Идентификатор сессии: 2 байта (идентификатор сессии внутри туннеля).
- Поле длины: 2 байта (длина пакета L2TP).

**2. L2TP-пакет**:

- Поле данных: Переменная длина (инкапсулированные данные, например, IP-пакет).  

### **Структура IPsec (ESP — Encapsulating Security Payload)**:

IPsec используется для шифрования и защиты передаваемых данных внутри туннеля. Один из основных компонентов IPsec — это ESP (Encapsulating Security Payload).

**1. ESP-заголовок**:

- SPI (Security Parameters Index): 4 байта (идентификатор параметров безопасности).
- Номер последовательности: 4 байта (идентификатор пакета для предотвращения повторных атак).
- Шифрованные данные: Переменная длина (зашифрованные данные).
- ESP-трейлер: Переменная длина (используется для выравнивания данных и обеспечения целостности).  

### **Преимущества**:

- **Безопасность**: Совмещение L2TP с IPsec делает протокол очень безопасным. IPsec использует современные и надежные алгоритмы шифрования.
- **Поддержка**: Широко поддерживается большинством операционных систем (Windows, macOS, Linux).

### **Недостатки**:

- **Производительность**: Из-за двойной инкапсуляции (L2TP + IPsec) протокол может иметь более высокую задержку по сравнению с другими VPN-протоколами.
- **Открытие портов**: L2TP использует UDP-порт 500, который может быть заблокирован в некоторых сетях, что делает его менее гибким в обходе ограничений.

### **Заключение**:
L2TP/IPsec — хороший выбор для безопасности, но может быть медленным из-за двойной инкапсуляции и может сталкиваться с трудностями в сетях с жесткими ограничениями.

## 1.3. OpenVPN

**Описание**: OpenVPN — это открытый VPN-протокол, который использует OpenSSL для шифрования и может работать через различные порты, включая TCP и UDP. Он считается одним из самых гибких и безопасных протоколов.

**Как работает**:

- **Шифрование**: OpenVPN использует OpenSSL-библиотеку для шифрования данных, поддерживающую различные алгоритмы, такие как AES, Blowfish и другие. Также OpenVPN поддерживает шифрование TLS для обеспечения безопасности.

- **Туннелирование**: OpenVPN может использовать как протоколы TCP, так и UDP для передачи данных, что делает его универсальным в различных сетевых средах.

- **Аутентификация**: OpenVPN поддерживает различные методы аутентификации, включая сертификаты X.509, пары ключей и двухфакторную аутентификацию.


### **Структура OpenVPN**:

OpenVPN использует протоколы SSL/TLS для шифрования и обмена ключами. В основе OpenVPN лежат пакеты TLS и инкапсуляция данных с помощью UDP или TCP.

**1. TLS-заголовок** (используется для аутентификации и обмена ключами):

- Тип сообщения: 1 байт (например, Handshake, Application Data).
- Версия: 2 байта (определяет версию TLS).
- Длина: 2 байта (длина сообщения).
- Данные: Переменная длина (зашифрованные данные или ключи).  

**2. OpenVPN-заголовок**:

- Magic Number: 4 байта (определяет, что это пакет OpenVPN).
- Версия: 1 байт (версия OpenVPN).
- ID сессии: 4 байта (идентификатор сессии).
- Поле данных: Переменная длина (инкапсулированные данные, такие как IP-пакет или пользовательские данные).  

### **Преимущества**:

- **Гибкость**: OpenVPN может работать через любые порты и использовать как TCP, так и UDP, что делает его отличным выбором для обхода сетевых ограничений и файрволов.
- **Безопасность**: Использует современные алгоритмы шифрования и поддерживает динамическое обновление ключей.
- **Открытый стандарт**: Поскольку OpenVPN — это открытый проект, его код можно проверять и улучшать сообществом, что повышает доверие к его безопасности.


### **Недостатки**:

- **Настройка**: В отличие от некоторых других VPN-протоколов, OpenVPN требует более сложной настройки как для клиента, так и для сервера.
- **Производительность**: Может быть более медленным, если используется с TCP, однако при использовании UDP демонстрирует высокую скорость.

### **Заключение**:
OpenVPN является одним из лучших вариантов для VPN-соединений благодаря своей гибкости и безопасности. Подходит для различных платформ и сетевых условий.

## 1.4. IKEv2/IPsec (Internet Key Exchange version 2)

**Описание**: IKEv2 — это протокол обмена ключами (Key Exchange), который используется для установки безопасного соединения между клиентом и сервером. В сочетании с IPsec он обеспечивает высокую скорость и надежное шифрование.

**Как работает**:

- **IKEv2**: Используется для обмена ключами и установления защищенного IPsec-туннеля. Он поддерживает механизмы пересогласования сессии при изменении сетевых условий.

- **IPsec**: Шифрует данные, передаваемые через соединение. IKEv2/IPsec поддерживает современные и безопасные алгоритмы шифрования, такие как AES.


### **Структура IKEv2 (Internet Key Exchange version 2)**:

IKEv2 — это протокол для обмена ключами и управления IPsec-туннелями. Он может быть представлен как набор сообщений, передаваемых между узлами.

**1. IKE-заголовок**:

- Initiator SPI: 8 байт (идентификатор инициатора).
- Responder SPI: 8 байт (идентификатор ответчика).
- Версия: 1 байт (номер версии IKE).
- Тип обмена: 1 байт (тип сообщения, например, запрос на установку соединения).
- Флаги: 1 байт (определяет, например, необходимость аутентификации).
- Номер сообщения: 4 байта (идентификатор сообщения).
- Поле данных: Переменная длина (содержит полезные данные или ключи).  

### **IPsec (ESP) заголовок**:

Использует такой же формат, как в L2TP/IPsec (описан выше).

### **Преимущества**:

- **Скорость**: IKEv2/IPsec очень быстрое решение благодаря эффективному управлению туннелями и минимальной задержке.
- **Поддержка мобильных устройств**: IKEv2 поддерживает механизм MOBIKE (IKEv2 Mobility and Multihoming Protocol), который позволяет соединению автоматически восстанавливаться при смене сетей, например, при переключении с Wi-Fi на мобильные данные.
- **Безопасность**: Протокол предлагает современные методы шифрования и защиты данных.

### **Недостатки**:

- **Блокировка портов**: Как и L2TP/IPsec, IKEv2 использует UDP-порт 500, который может быть заблокирован в некоторых сетях.
- **Ограниченные платформы**: Хотя IKEv2/IPsec поддерживается большинством современных операционных систем, его гибкость ниже, чем у OpenVPN.

### **Заключение**:
IKEv2/IPsec — отличный выбор для мобильных устройств благодаря своей скорости и способности восстанавливать соединение при смене сетей. Также это один из самых безопасных протоколов.

## 1.5. WireGuard

**Описание**: WireGuard — относительно новый VPN-протокол, который создан с целью быть простым, быстрым и легковесным. Он использует современные криптографические алгоритмы и имеет небольшую кодовую базу, что делает его высокоэффективным и безопасным.

**Как работает**:

- **Шифрование**: WireGuard использует современные криптографические примитивы, такие как ChaCha20 для шифрования и Poly1305 для аутентификации данных.

- **Туннелирование**: Все данные передаются через UDP, что обеспечивает высокую скорость и низкую задержку. WireGuard также использует статические ключи для аутентификации, что упрощает процесс установления соединения.    

### **Структура WireGuard**:

WireGuard спроектирован так, чтобы быть минималистичным и легковесным. В основе WireGuard лежат современные криптографические примитивы, такие как ChaCha20 для шифрования.

**1. WireGuard-заголовок**:

- Message Type: 1 байт (определяет тип сообщения, например, Handshake Initiation, Data Transfer).
- Receiver Index: 4 байта (идентификатор получателя).
- Nonce: 12 байт (одноразовое значение для предотвращения повторных атак).
- Поле данных: Переменная длина (зашифрованные данные).  

**2. WireGuard-пакет данных**:

- Поле данных: Переменная длина (инкапсулированные данные, такие как IP-пакет). 

### **Преимущества**:

- **Производительность**: WireGuard демонстрирует очень высокие скорости за счет минималистичного дизайна и работы через UDP.

- **Простота**: Сравнительно небольшая кодовая база (~4000 строк кода) делает его легко проверяемым и менее подверженным уязвимостям.

- **Безопасность**: Использование современных криптографических методов обеспечивает высокую степень безопасности.
   

### **Недостатки**:

- **Юность**: Как относительно новый протокол, WireGuard пока не так широко поддерживается и не имеет столь долгой истории использования, как другие протоколы (например, OpenVPN или IPsec).

- **Управление ключами**: WireGuard использует статические ключи для аутентификации, что может быть менее гибким в некоторых сценариях.
   

### **Заключение**:
WireGuard предлагает отличное сочетание скорости, безопасности и простоты. Это перспективный протокол, который набирает популярность, хотя он еще не так широко поддерживается, как более старые решения.

## **Выводы по протоколам:**

- **PPTP**: Устарел и небезопасен, рекомендуется избегать.
- **L2TP/IPsec**: Безопасный, но медленный и может сталкиваться с блокировкой портов.
- **OpenVPN**: Очень гибкий и безопасный, но требует более сложной настройки.
- **IKEv2/IPsec**: Быстрый и надежный, особенно для мобильных устройств.
- **WireGuard**: Новый, легковесный и быстрый, но пока не так широко поддерживается.

## 2. **Шифрование (Encryption)**

Шифрование — это ключевой элемент VPN, который защищает передаваемые данные от перехвата третьими лицами. Существует несколько популярных алгоритмов шифрования, которые используются в VPN:

- **AES (Advanced Encryption Standard)** — один из самых популярных стандартов шифрования, который обеспечивает как высокую безопасность, так и производительность. Обычно используется с ключами длиной 128, 192 или 256 бит.
    
- **ChaCha20** — современный алгоритм шифрования, который часто используется в мобильных устройствах благодаря своей эффективности на устройствах с низкой вычислительной мощностью.
    
- **RSA** — асимметричный алгоритм шифрования, который используется для обмена ключами шифрования и аутентификации.
    
- **HMAC (Hash-based Message Authentication Code)** — используется для обеспечения целостности данных и проверки их подлинности.

## 3. **Аутентификация (Authentication)**

VPN использует различные методы аутентификации для подтверждения подлинности клиента и сервера. Это предотвращает возможность подключения злоумышленников к VPN-серверу. Существует несколько методов аутентификации:

- **Sertifikaty X.509** — используются для аутентификации клиента и сервера с помощью цифровых сертификатов.
    
- **Пароль и имя пользователя** — стандартный метод аутентификации, который используется в менее защищённых настройках.
    
- **PSK (Pre-Shared Key)** — предварительно распределённый ключ, который используется для аутентификации клиента и сервера.
    
- **Двухфакторная аутентификация (2FA)** — добавляет дополнительный уровень безопасности, требуя ввода одноразового кода с другого устройства.

## 4. **IPsec (Internet Protocol Security)**

IPsec — это набор протоколов, который обеспечивает безопасную передачу данных на сетевом уровне (уровень 3 сетевой модели OSI). IPsec может работать в двух режимах:

- **Транспортный режим** — шифруются только данные в пакете, но заголовки остаются открытыми. Этот режим чаще используется для внутренней сети.
    
- **Туннельный режим** — шифруется весь IP-пакет, включая заголовки. Это наиболее популярный режим для VPN, поскольку он обеспечивает максимальную конфиденциальность.

## 5. **Маршрутизация и NAT (Network Address Translation)**

Когда вы подключаетесь к VPN, ваш трафик перенаправляется через VPN-сервер. Сервер может изменить ваш реальный IP-адрес с помощью NAT (маскировка адреса), чтобы сделать вас анонимным в сети. Например, веб-сайты будут видеть IP-адрес VPN-сервера, а не ваш реальный IP-адрес.

Существует два основных типа VPN:

- **Site-to-Site VPN** — используется для соединения двух частных сетей через Интернет. Это решение часто используется для объединения офисов в одну корпоративную сеть.
    
- **Client-to-Site VPN** — это более распространённый вариант, когда отдельный пользователь подключается к частной сети через общедоступную сеть (например, домашний пользователь подключается к корпоративной сети).

## 6. **Политики и управление VPN**

Для управления VPN-сессиями используются различные политики и механизмы контроля. Например:

- **Политики маршрутизации** — определяют, какой трафик должен проходить через VPN, а какой может идти напрямую в интернет.
    
- **Политики шифрования** — задают уровни шифрования и аутентификации для различных пользователей и устройств.
    
- **Политики доступа** — определяют, какие ресурсы доступны пользователям через VPN.

## 7. **DNS и утечки (DNS Leaks)**

Когда вы подключаетесь к VPN, ваш DNS-трафик (запросы, которые определяют IP-адреса веб-сайтов) также должен проходить через VPN-сервер. Однако в некоторых случаях возможны "утечки DNS", когда DNS-запросы обрабатываются через вашего локального провайдера, а не через VPN. Это может раскрыть ваш реальный IP-адрес и местоположение. Многие VPN-сервисы предлагают защиту от утечек DNS.


## 8. **Kill Switch**

Механизм "Kill Switch" используется для защиты данных в случае разрыва соединения с VPN. Если VPN-соединение внезапно прерывается, Kill Switch блокирует весь интернет-трафик, чтобы предотвратить утечку данных через незащищённое соединение.

## Заключение

VPN работает путём создания безопасного туннеля между вашим устройством и сервером, используя при этом шифрование и аутентификацию для защиты данных. Основными компонентами VPN являются протоколы туннелирования (OpenVPN, L2TP, IKEv2 и др.), методы шифрования (AES, RSA), а также механизмы маршрутизации и NAT.