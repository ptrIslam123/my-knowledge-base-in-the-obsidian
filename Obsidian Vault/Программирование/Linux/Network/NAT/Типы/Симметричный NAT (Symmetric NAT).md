## **1. Фундаментальная концепция**

**Симметричный NAT** (Symmetric NAT) — трансляция, при которой каждое соединение, инициируемое парой **<внутренний адрес: внутренний порт>**, преобразуется в свободную уникальную случайно выбранную пару **<публичный адрес: публичный порт>**. **При этом инициация соединения из публичной сети невозможна**.

### **Механизм работы Symmetric NAT:**

### **NAT Table с временными метками:**
```bash
# Расширенная таблица NAT с управлением временем жизни
┌──────────────────────┬────────────────────┬────────────────────┬─────────────┐
│ Внутренний           │ Внешний            │ Удаленный хост     │ Время жизни │
├──────────────────────┼────────────────────┼────────────────────┼─────────────┤
│ 192.168.1.10:54321   │ 85.21.78.50:31000  │ 93.184.216.34:80   │ 3600 сек    │
└──────────────────────┴────────────────────┴────────────────────┴─────────────┘
```

## **Процесс работы сессии**

### **Исходящий пакет**

Допустим, у него такие параметры:
- src-ip = 192.168.1.10
- src-port = 54321  
- dst-ip = 93.184.216.34
- dst-port = 80

Маршрутизатор смотрит в таблице, присутствует ли запись с src-ip & src-port & dst-ip & dst-port:

* **Если присутствует:**
  - Сбрасывает счетчик времени жизни сессии
  - Отправляет пакет по dst-ip/dst-port

* **Если отсутствует:**
  - Добавляется новая запись типа:
    **Запись: 192.168.1.10:54321 | 85.21.78.50:31000 | 93.184.216.34:80 | 3600 секунд**
  - Пара 85.21.78.50:31000 - свободный публичный ip-addr & ip-port из пула публичных адресов маршрутизатора

### **Входящий пакет**

Допустим, у него такие параметры:
- src-ip = 93.184.216.34
- src-port = 80
- dst-ip = 85.21.78.50  
- dst-port = 31000

Маршрутизатор смотрит в таблице и ищет запись с dst-ip & dst-port & src-ip & src-port:

* **Если присутствует:**
  - Проверяет таймаут (истек ли)
  - При истечении таймаута отбрасывает пакет, а запись удаляется из таблицы а адрес и порт снова отправляются в пул свободных для переиспользования
  - Если таймаут не истек, маршрутизатор пересылает внутреннему хосту под NAT 192.168.1.10:54321, который указан в записи таблицы

* **Если отсутствует:**
  - Маршрутизатор просто отбрасывает подобные пакеты

---
#### **1. Уточнение про "пул адресов":**
```bash
# У большинства маршрутизаторов:
- 1 публичный IP, но 64511 портов (1024-65535)
- Пулу "свободных" обычно = все порты выше 1024
```

#### **2. Алгоритм выбора порта:**
```bash
# Обычно используется:
- Случайный выбор из диапазона 1024-65535
- Или последовательное выделение
- НЕ используется оригинальный порт клиента
```

#### **3. Edge case - исчерпание портов:**
```bash
# Что если все порты заняты?
- Отказ в обслуживании новых соединений
- Или агрессивная очистка старых записей
```

---
## **Типичные времена жизни**

### **Зависит от протокола:**
```bash
# TCP соединения:
- Established: 24 часа (86400 секунд)
- После FIN/ACK: 2-5 минут
- После RST: 1-2 минуты

# UDP "сессии":
- Общий таймаут: 30-300 секунд
- Сбрасывается при каждом пакете

# ICMP:
- 30-60 секунд
```


## **Где встречается Symmetric NAT**

### **Корпоративные сети:**
```bash
# Банки, крупные компании, госучреждения
Причины: Безопасность, политики изоляции, compliance
```

### **Мобильные операторы:**
```bash
# LTE/5G сети многих операторов
Причины: Экономия IPv4, безопасность, управление трафиком
```

### **Публичные Wi-Fi сети:**
```bash
# Аэропорты, кафе, гостиницы
Причины: Защита пользователей, предотвращение атак
```

### **Некоторые домашние роутеры:**
```bash
# Роутеры с "усиленной безопасностью"
Причины: Производитель считает это более безопасным
```

## **Определение Symmetric NAT**

### **Методика тестирования:**
```bash
# 1. Подключиться к STUN серверу A → получить порт X
# 2. Подключиться к STUN серверу B → получить порт Y
# 3. Если X ≠ Y → Symmetric NAT
```

